# Push Notifications Explained - Simple Guide

## üîë What is a Push Token?

Think of a **push token** like a **mailing address** for your phone.

### Real-World Analogy:
- **Your Home Address** = Push Token
- **The Post Office** = Expo's Push Notification Service
- **A Letter** = The Notification
- **Your Mailbox** = Your Phone

Just like you need a unique address to receive mail, your phone needs a unique **push token** to receive notifications.

### Technical Explanation:

A **push token** is a **unique string** that identifies:
1. **Which device** (your specific iPhone/Android)
2. **Which app** (Sikiya app)
3. **Which installation** (if you uninstall and reinstall, you get a new token)

**Example Push Token:**
```
ExponentPushToken[AbCdEf123456GhIjKl789012MnOpQr345678StUvWx901234]
```

This token is:
- ‚úÖ **Unique** - No two devices have the same token
- ‚úÖ **Generated by Expo** - When your app first requests it
- ‚úÖ **Stored in your backend** - So you know where to send notifications
- ‚úÖ **Can change** - If user uninstalls/reinstalls app, or if they clear app data

---

## üì® How Are Notifications Sent? (Step-by-Step)

### The Complete Flow:

```
1. User Opens App
   ‚Üì
2. App Requests Permission ("Allow notifications?")
   ‚Üì
3. User Grants Permission
   ‚Üì
4. App Gets Push Token from Expo
   ‚Üì
5. App Sends Token to YOUR Backend
   ‚Üì
6. Backend Stores Token in Database
   ‚Üì
7. [Later...] Something Happens (new article, comment, etc.)
   ‚Üì
8. YOUR Backend Decides to Send Notification
   ‚Üì
9. Backend Gets User's Token from Database
   ‚Üì
10. Backend Sends Request to Expo's Servers
    POST https://exp.host/--/api/v2/push/send
    {
      "to": "ExponentPushToken[...]",
      "title": "New Article!",
      "body": "Check out the latest news"
    }
   ‚Üì
11. Expo's Servers Forward to Apple/Google
   ‚Üì
12. Apple/Google Push to Device
   ‚Üì
13. Device Shows Notification to User
```

### Detailed Breakdown:

#### **Step 1-5: Getting the Token (One-Time Setup)**
When a user first opens your app:
1. Your app asks: "Can I send you notifications?"
2. User says "Yes"
3. Your app calls Expo: "Hey Expo, give me a push token for this device"
4. Expo responds: "Here's your token: `ExponentPushToken[xxx]`"
5. Your app sends this token to YOUR backend: `POST /user/push-token`
6. Your backend saves it: `User.pushToken = "ExponentPushToken[xxx]"`

#### **Step 6-13: Sending a Notification (When Needed)**
Later, when you want to notify a user:
1. Something happens (e.g., new article published)
2. Your backend code runs: "I should notify user X"
3. Your backend looks up user X in database: `const user = await User.findById(userId)`
4. Your backend gets their token: `const token = user.pushToken`
5. Your backend sends to Expo:
   ```javascript
   axios.post('https://exp.host/--/api/v2/push/send', {
     to: token,
     title: "New Article!",
     body: "Check out the latest news"
   })
   ```
6. Expo's servers receive your request
7. Expo forwards to Apple (for iOS) or Google (for Android)
8. Apple/Google push to the device
9. Device shows notification

### Why This Architecture?

```
Your Backend ‚Üí Expo ‚Üí Apple/Google ‚Üí Device
```

**Why not send directly?**
- ‚ùå You can't directly connect to Apple/Google servers
- ‚ùå You'd need complex certificates and setup
- ‚úÖ Expo handles all the complexity for you
- ‚úÖ You just send a simple HTTP request to Expo

---

## üÜî What is Project ID?

The **Project ID** is like a **project number** that Expo uses to identify your app.

### Real-World Analogy:
- **Project ID** = Your Social Security Number
- **Expo** = The Government
- Just like your SSN identifies you to the government, your Project ID identifies your app to Expo

### Technical Explanation:

**Project ID** is a **unique identifier** that:
- ‚úÖ Links your app to your Expo account
- ‚úÖ Allows Expo to generate push tokens correctly
- ‚úÖ Ensures tokens work with your specific app
- ‚úÖ Is required for push notifications to work

**Example Project ID:**
```
960ca8c8-7e44-4e44-9c92-f52c3fc09da2
```

This is a **UUID** (Universally Unique Identifier) - a long random string that's guaranteed to be unique.

### Where Do You Get It?

#### **Option 1: From app.json (Already Set Up!) ‚úÖ**

Your `app.json` already has it:
```json
{
  "expo": {
    "extra": {
      "eas": {
        "projectId": "960ca8c8-7e44-4e44-9c92-f52c3fc09da2"
      }
    }
  }
}
```

This was created when you set up EAS (Expo Application Services).

#### **Option 2: From Expo Dashboard**

1. Go to [https://expo.dev](https://expo.dev)
2. Log in to your account
3. Click on your project "Sikiya"
4. Go to **Settings** or **Project Information**
5. You'll see the **Project ID** listed there

#### **Option 3: Create a New One**

If you don't have one:
1. Install EAS CLI: `npm install -g eas-cli`
2. Login: `eas login`
3. Configure: `eas build:configure`
4. This will create a project ID and add it to `app.json`

### How is Project ID Used?

When your app requests a push token:
```javascript
const tokenData = await Notifications.getExpoPushTokenAsync({
  projectId: '960ca8c8-7e44-4e44-9c92-f52c3fc09da2'
});
```

Expo uses this ID to:
1. Verify the request is from your app
2. Generate a token that's linked to your project
3. Ensure notifications sent to this token reach YOUR app (not someone else's)

### Important Notes:

- ‚úÖ **One Project ID per app** - Don't change it once set
- ‚úÖ **Same ID for iOS and Android** - One project ID works for both
- ‚úÖ **Stored in app.json** - No need for `.env` file
- ‚ö†Ô∏è **Don't share it publicly** - It's not secret, but it's your app's identifier

---

## üîÑ Complete Example: Sending a Notification

Let's say a journalist publishes a new article and you want to notify their followers:

### Backend Code:

```javascript
// 1. New article is published
const article = await Article.create({...});

// 2. Get all users who follow this journalist
const Followers = require('./models/Followers');
const followers = await Followers.find({ 
  following_id: article.journalist_id 
});

// 3. Get push tokens for all followers
const User_login = require('./models/User_login');
const followerIds = followers.map(f => f.follower_id);

const users = await User_login.find({ 
  _id: { $in: followerIds },
  pushToken: { $ne: null } // Only users with push tokens
});

// 4. Send notification to each follower
const axios = require('axios');

for (const user of users) {
  try {
    await axios.post('https://exp.host/--/api/v2/push/send', {
      to: user.pushToken,
      title: 'New Article Published!',
      body: `${article.journalist_name} just published: ${article.title}`,
      data: {
        type: 'new_article',
        articleId: article._id.toString(),
        journalistId: article.journalist_id.toString()
      },
      sound: 'default',
      priority: 'high'
    });
    
    console.log(`Notification sent to user ${user._id}`);
  } catch (error) {
    console.error(`Failed to send to user ${user._id}:`, error);
  }
}
```

### What Happens:

1. **Backend** creates article
2. **Backend** finds all followers
3. **Backend** gets their push tokens from database
4. **Backend** sends notification request to Expo for each token
5. **Expo** forwards to Apple/Google
6. **Apple/Google** push to devices
7. **Users** see notification on their phones

---

## üìä Summary

| Concept | What It Is | Where It's Used |
|---------|-----------|----------------|
| **Push Token** | Unique address for a device/app | Stored in backend, used to send notifications |
| **Project ID** | Unique identifier for your app | Used when requesting push tokens |
| **Expo Push API** | Service that forwards notifications | Your backend sends requests here |
| **Apple/Google** | Platform push services | Expo forwards to them, they push to devices |

---

## üéØ Key Takeaways

1. **Push Token** = Device's "mailing address" for notifications
2. **Project ID** = Your app's "ID number" with Expo
3. **Flow**: Your Backend ‚Üí Expo ‚Üí Apple/Google ‚Üí Device
4. **Token is stored** in your database when user logs in
5. **You send notifications** by making HTTP requests to Expo's API

---

## ‚ùì Common Questions

**Q: Can I send notifications without Expo?**
A: Yes, but it's much more complex. You'd need to:
- Set up APNs (Apple Push Notification service) certificates
- Set up FCM (Firebase Cloud Messaging) for Android
- Handle different formats for iOS vs Android
- Manage certificates and credentials

**Q: What if a user uninstalls the app?**
A: The token becomes invalid. Expo will return an error when you try to send. You should remove invalid tokens from your database.

**Q: Can I send to multiple users at once?**
A: Yes! You can send to up to 100 tokens in one request:
```javascript
await axios.post('https://exp.host/--/api/v2/push/send', {
  to: [token1, token2, token3, ...], // Array of tokens
  title: "Broadcast",
  body: "Message to everyone"
});
```

**Q: Do I need different tokens for iOS and Android?**
A: No! One token works for both. Expo handles the platform differences automatically.

---

**Need more help?** Check the Expo documentation or ask specific questions!

